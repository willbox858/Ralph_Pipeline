{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/refactor-spec-schema.json",
  "title": "Refactor Spec Schema Extension",
  "description": "Schema extension for refactoring-specific spec fields. Extends base spec-schema.json.",
  "type": "object",

  "properties": {
    "refactor": {
      "type": "object",
      "description": "Refactoring-specific configuration and state",
      "required": ["type", "target"],
      "properties": {

        "type": {
          "type": "string",
          "enum": ["incremental", "strangler_fig", "extract", "restructure"],
          "description": "Type of refactoring being performed",
          "default": "incremental"
        },

        "target": {
          "type": "string",
          "description": "Path to code being refactored (file, directory, or class name)"
        },

        "goals": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "reduce_complexity",
              "improve_testability",
              "extract_components",
              "modernize_patterns",
              "improve_performance",
              "fix_architecture",
              "other"
            ]
          },
          "description": "User's stated goals for the refactoring"
        },

        "baseline_commit": {
          "type": "string",
          "description": "Git commit hash before refactoring started"
        },

        "baseline_branch": {
          "type": "string",
          "description": "Branch name before refactoring (for rollback)"
        },

        "analysis_approved": {
          "type": "boolean",
          "description": "Whether user has approved the analysis results",
          "default": false
        },

        "current_step": {
          "type": "integer",
          "minimum": 0,
          "description": "Index of current refactoring step (0-based)"
        },

        "current_phase": {
          "type": "string",
          "enum": ["analysis", "approval", "execution", "verification", "complete", "blocked"],
          "description": "Current phase of the refactoring pipeline"
        },

        "test_groups": {
          "type": "array",
          "items": { "$ref": "#/$defs/test_group" },
          "description": "Groups of tests that validate refactoring steps"
        },

        "steps_completed": {
          "type": "array",
          "items": { "$ref": "#/$defs/completed_step" },
          "description": "Refactoring steps that have been successfully applied"
        },

        "steps_remaining": {
          "type": "array",
          "items": { "type": "string" },
          "description": "IDs of refactoring opportunities not yet applied"
        },

        "analysis_path": {
          "type": "string",
          "description": "Path to analysis.json file"
        }
      }
    }
  },

  "$defs": {
    "test_group": {
      "type": "object",
      "required": ["name", "tests"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Identifier for this test group"
        },
        "tests": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of test identifiers (e.g., 'tests/test_foo.py::test_bar')"
        },
        "covers": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Functions/classes this group covers"
        },
        "status": {
          "type": "string",
          "enum": ["unknown", "passing", "failing", "skipped"],
          "description": "Current status of this test group"
        },
        "last_run": {
          "type": "string",
          "format": "date-time",
          "description": "When tests were last executed"
        },
        "checkpoint_order": {
          "type": "integer",
          "minimum": 1,
          "description": "Suggested order for using this group as a checkpoint"
        }
      }
    },

    "completed_step": {
      "type": "object",
      "required": ["id", "commit", "timestamp"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Refactoring opportunity ID (e.g., 'RO-001')"
        },
        "commit": {
          "type": "string",
          "description": "Git commit hash after this step"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When this step was completed"
        },
        "tests_passed": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Test groups that passed after this step"
        },
        "files_modified": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Files changed in this step"
        }
      }
    },

    "refactor_analysis": {
      "type": "object",
      "description": "Output from Analyzer agent (stored in analysis.json)",
      "properties": {
        "target": { "type": "string" },
        "analyzed_at": { "type": "string", "format": "date-time" },

        "structure": {
          "type": "object",
          "properties": {
            "classes": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "name": { "type": "string" },
                  "line_start": { "type": "integer" },
                  "line_end": { "type": "integer" },
                  "methods": { "type": "array", "items": { "type": "string" } },
                  "complexity": { "type": "integer" }
                }
              }
            },
            "functions": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "name": { "type": "string" },
                  "line_start": { "type": "integer" },
                  "line_end": { "type": "integer" },
                  "complexity": { "type": "integer" }
                }
              }
            },
            "imports": {
              "type": "object",
              "properties": {
                "internal": { "type": "array", "items": { "type": "string" } },
                "external": { "type": "array", "items": { "type": "string" } }
              }
            },
            "complexity_hotspots": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "name": { "type": "string" },
                  "complexity": { "type": "integer" },
                  "recommendation": { "type": "string" }
                }
              }
            }
          }
        },

        "test_coverage": {
          "type": "object",
          "properties": {
            "overall_percentage": { "type": "number", "minimum": 0, "maximum": 100 },
            "by_function": {
              "type": "object",
              "additionalProperties": { "type": "number" }
            },
            "uncovered_functions": { "type": "array", "items": { "type": "string" } },
            "test_run_success": { "type": "boolean" },
            "error": { "type": "string" },
            "fallback": { "type": "string" }
          }
        },

        "test_groups": {
          "type": "array",
          "items": { "$ref": "#/$defs/test_group" }
        },

        "suggested_seams": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "location": { "type": "string" },
              "seam_type": {
                "type": "string",
                "enum": ["dependency_injection", "extract_interface", "wrap_method", "link_seam", "preprocessing_seam"]
              },
              "current_code": { "type": "string" },
              "suggested_change": { "type": "string" },
              "rationale": { "type": "string" },
              "difficulty": { "type": "string", "enum": ["low", "medium", "high"] }
            }
          }
        },

        "refactoring_opportunities": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "type", "target"],
            "properties": {
              "id": { "type": "string", "pattern": "^RO-[0-9]{3}$" },
              "type": {
                "type": "string",
                "enum": ["extract_method", "extract_class", "introduce_parameter", "introduce_seam", "wrap_method", "strangler_fig", "rename", "move"]
              },
              "target": { "type": "string" },
              "reason": { "type": "string" },
              "suggested_extractions": { "type": "array", "items": { "type": "string" } },
              "pattern": { "type": "string" },
              "tests_affected": { "type": "array", "items": { "type": "string" } },
              "estimated_risk": { "type": "string", "enum": ["low", "medium", "high"] },
              "coverage_before": { "type": "number" }
            }
          }
        },

        "warnings": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["dynamic_usage", "parse_error", "circular_dependency", "low_coverage", "no_tests"]
              },
              "location": { "type": "string" },
              "detail": { "type": "string" },
              "recommendation": { "type": "string" }
            }
          }
        },

        "recommended_order": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "step": { "type": "integer" },
              "action": { "type": "string" },
              "rationale": { "type": "string" },
              "checkpoint": { "type": "string" }
            }
          }
        }
      }
    }
  }
}
