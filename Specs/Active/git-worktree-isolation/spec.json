{
  "name": "git-worktree-isolation",
  "version": "1.0.0",
  "status": "complete",
  "author": "user",
  "created": "2026-01-29",
  "updated": "2026-01-29T10:17:58.827465+00:00",
  "overview": {
    "problem": "Agents working in the same directory cause conflicts, make rollback difficult, and create unstable states when changes fail verification.",
    "success": "Each spec gets a branch matching the spec hierarchy. Agents work in isolated worktrees. Merges flow up the hierarchy. Arbitrary rollback via git.",
    "context": "Shared infrastructure for both feature and refactor pipelines. Branch hierarchy mirrors spec hierarchy - when shared/ merges, only direct siblings sync, not grandchildren."
  },
  "interfaces": {
    "provides": [
      {
        "name": "WorktreeManager",
        "description": "Creates and manages git worktrees following spec hierarchy",
        "members": [
          {
            "name": "create_spec_branch",
            "signature": "create_spec_branch(spec_path: string, parent_branch: string) -> BranchInfo",
            "expectations": "Creates branch for spec off parent branch (e.g., feature-x/parser off feature-x)"
          },
          {
            "name": "create_worktree",
            "signature": "create_worktree(branch: string) -> WorktreeInfo",
            "expectations": "Creates worktree for agent to work in"
          },
          {
            "name": "merge_up",
            "signature": "merge_up(child_branch: string, parent_branch: string) -> MergeResult",
            "expectations": "Merges verified child branch into parent branch"
          },
          {
            "name": "sync_from_parent",
            "signature": "sync_from_parent(child_branch: string, parent_branch: string) -> SyncResult",
            "expectations": "Rebases child on parent (for getting shared type updates)"
          },
          {
            "name": "rollback",
            "signature": "rollback(branch: string, to_commit: string | null) -> void",
            "expectations": "Resets branch to commit, or discards all changes if null"
          },
          {
            "name": "cleanup",
            "signature": "cleanup(spec_path: string) -> void",
            "expectations": "Removes worktree and branch after spec completion"
          }
        ]
      },
      {
        "name": "FileOwnershipTracker",
        "description": "Tracks file ownership in database to prevent conflicts",
        "members": [
          {
            "name": "claim_files",
            "signature": "claim_files(spec_path: string, file_patterns: string[]) -> ClaimResult",
            "expectations": "Registers ownership. Fails if already claimed by another active spec."
          },
          {
            "name": "check_ownership",
            "signature": "check_ownership(file_path: string) -> OwnerInfo | null",
            "expectations": "Returns owner spec, or null if unclaimed"
          },
          {
            "name": "release_files",
            "signature": "release_files(spec_path: string) -> void",
            "expectations": "Releases all claims for spec on completion"
          }
        ]
      }
    ],
    "requires": [
      {
        "name": "Git",
        "description": "Git CLI available in PATH"
      },
      {
        "name": "RalphDatabase",
        "description": ".ralph/ralph.db for tracking ownership"
      }
    ],
    "shared_types": [
      {
        "name": "BranchInfo",
        "kind": "class",
        "description": "Information about a spec branch"
      },
      {
        "name": "WorktreeInfo",
        "kind": "class",
        "description": "Information about a worktree"
      },
      {
        "name": "MergeResult",
        "kind": "class",
        "description": "Result of merge operation"
      }
    ]
  },
  "structure": {
    "is_leaf": true,
    "children": [],
    "composition": "",
    "classes": [
      {
        "name": "WorktreeManager",
        "type": "class",
        "responsibility": "Git branch/worktree lifecycle following spec hierarchy",
        "location": "src/ralph/worktree.py"
      },
      {
        "name": "FileOwnershipTracker",
        "type": "class",
        "responsibility": "Track file ownership in database",
        "location": "src/ralph/file_ownership.py"
      }
    ],
    "dependencies": []
  },
  "criteria": {
    "acceptance": [
      {
        "id": "AC-001",
        "behavior": "",
        "test": "",
        "passed": null
      },
      {
        "id": "AC-002",
        "behavior": "",
        "test": "",
        "passed": null
      },
      {
        "id": "AC-003",
        "behavior": "",
        "test": "",
        "passed": null
      },
      {
        "id": "AC-004",
        "behavior": "",
        "test": "",
        "passed": null
      },
      {
        "id": "AC-005",
        "behavior": "",
        "test": "",
        "passed": null
      },
      {
        "id": "AC-006",
        "behavior": "",
        "test": "",
        "passed": null
      },
      {
        "id": "AC-007",
        "behavior": "",
        "test": "",
        "passed": null
      },
      {
        "id": "AC-008",
        "behavior": "",
        "test": "",
        "passed": null
      }
    ],
    "edge_cases": [
      {
        "id": "EC-001",
        "behavior": "",
        "test": "",
        "passed": null
      },
      {
        "id": "EC-002",
        "behavior": "",
        "test": "",
        "passed": null
      },
      {
        "id": "EC-003",
        "behavior": "",
        "test": "",
        "passed": null
      }
    ],
    "integration": [
      {
        "id": "IT-001",
        "behavior": "",
        "test": "",
        "passed": null
      },
      {
        "id": "IT-002",
        "behavior": "",
        "test": "",
        "passed": null
      },
      {
        "id": "IT-003",
        "behavior": "",
        "test": "",
        "passed": null
      }
    ]
  },
  "constraints": {
    "tech_stack": "python",
    "scope_boundaries": [
      "Does NOT auto-resolve conflicts",
      "Does NOT modify orchestrator - provides library for orchestrator to call"
    ],
    "performance": [
      "Worktree creation should complete in under 2 seconds"
    ],
    "security": [],
    "open_questions": []
  },
  "verification": {
    "tests_passed": true,
    "lint_passed": true,
    "build_passed": true,
    "deviations": [],
    "summary": "All 61 tests passing. WorktreeManager and FileOwnershipTracker implemented in src/ralph/."
  },
  "runtime": {
    "depth": 0,
    "ralph_iteration": 7,
    "all_tests_passed": true,
    "integration_tests_passed": true,
    "depends_on": [],
    "errors": null
  }
}